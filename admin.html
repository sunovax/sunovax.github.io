<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SUNOVAX Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;background:#081821;color:#fff;padding:20px}
h2{color:#ffd84d;text-align:center}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border-bottom:1px solid #333;text-align:center}
button{padding:7px 12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
.enable{background:#4caf50}
.disable{background:#f44336;color:#fff}
.timer{color:#7CFC98}
</style>
</head>

<body>
<h2>SUNOVAX â€“ Admin Panel</h2>

<table>
<thead>
<tr>
<th>User</th>
<th>Status</th>
<th>Timer</th>
<th>PIN</th>
<th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {getFirestore,collection,onSnapshot,doc,updateDoc,deleteDoc} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyBYWFWFQaJZ-i4GU12tlCvLNjfY1s3aeJQ",
  projectId:"sunovax"
});
const db=getFirestore(app);
const ADMIN_PIN="2026";

onSnapshot(collection(db,"sessions"),snap=>{
  rows.innerHTML="";
  const list=snap.docs
    .map(d=>({id:d.id,...d.data()}))
    .sort((a,b)=>b.created-a.created);

  list.forEach((s,i)=>{
    rows.innerHTML+=`
    <tr>
      <td>User ${i+1}</td>
      <td>${s.charging?"Charging":"Waiting"}</td>
      <td class="timer" id="t${s.id}">--</td>
      <td><input id="p${s.id}" type="password" style="width:70px"></td>
      <td>
        ${!s.charging
          ?`<button class="enable" onclick="enable('${s.id}',${s.duration})">Enable</button>`
          :`<button class="disable" onclick="disable('${s.id}')">Disable</button>`}
      </td>
    </tr>`;
    if(s.charging) timer(s.id,s.endsAt);
  });
});

window.enable=async(id,dur)=>{
  if(document.getElementById("p"+id).value!==ADMIN_PIN)
    return alert("Wrong PIN");

  await updateDoc(doc(db,"sessions",id),{
    charging:true,
    endsAt:Date.now()+dur*1000
  });
};

window.disable=async(id)=>{
  await deleteDoc(doc(db,"sessions",id));
};

function timer(id,end){
  setInterval(()=>{
    const t=end-Date.now();
    if(t<=0) deleteDoc(doc(db,"sessions",id));
    const m=Math.floor(t/60000)%60;
    const s=Math.floor(t/1000)%60;
    document.getElementById("t"+id).textContent=`${m}:${s}`;
  },1000);
}
</script>
</body>
</html>
